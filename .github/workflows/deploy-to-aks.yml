name: Build, Push, and Deploy to AKS

on:
  push:
    branches:
      - main # Trigger on pushes to the main branch
    paths:
      - 'Project7/**' # Only trigger if changes are within the Project7 folder

env:
  RESOURCE_GROUP: aks-dev-rg      # Your Azure Resource Group name
  AKS_CLUSTER_NAME: myakscluster  # Your AKS cluster name
  ACR_NAME: aksdevacr007          # Your Azure Container Registry name
  ACR_LOGIN_SERVER: aksdevacr007.azurecr.io # Your ACR login server

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}

    - name: Build and push Frontend image
      # Path corrected: Now uses Project7/frontend
      run: |
        docker build ./Project7/frontend -t ${{ env.ACR_LOGIN_SERVER }}/aks-frontend:${{ github.sha }}
        docker push ${{ env.ACR_LOGIN_SERVER }}/aks-frontend:${{ github.sha }}

    - name: Build and push Backend image
      # Path corrected: Now uses Project7/backend
      run: |
        docker build ./Project7/backend -t ${{ env.ACR_LOGIN_SERVER }}/aks-backend:${{ github.sha }}
        docker push ${{ env.ACR_LOGIN_SERVER }}/aks-backend:${{ github.sha }}

  deploy-to-aks:
    needs: build-and-push-images # This job depends on successful image builds and pushes
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS credentials
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER_NAME }}
        # No admin-user needed, managed identity handles image pull

    - name: Update and Deploy Frontend to AKS
      run: |
        # Path corrected: Now uses Project7/frontend-deployment.yaml
        sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ github.sha }}|g" Project7/frontend-deployment.yaml
        kubectl apply -f Project7/frontend-deployment.yaml
        # Trigger a rolling update for the deployment to ensure the new image is pulled
        kubectl rollout restart deployment/frontend-deployment -n default

    - name: Update and Deploy Backend to AKS
      run: |
        # Path corrected: Now uses Project7/backend-deployment.yaml
        sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ github.sha }}|g" Project7/backend-deployment.yaml
        kubectl apply -f Project7/backend-deployment.yaml
        # Trigger a rolling update for the deployment to ensure the new image is pulled
        kubectl rollout restart deployment/backend-deployment -n default
